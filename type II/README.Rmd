---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

library(tidyverse, warn.conflicts= FALSE)
require(scales, warn.conflicts= FALSE)
options(dplyr.summarise.inform = FALSE)
```
# Data Overview
Similar to type I error rates, type II error rates are estimated. The main changes are the alternative hypothesis is true, the null hypothesis is held constant and effect size varies. The first five data points look like

```{r topFiveOne, echo=FALSE, message=FALSE}
temp <- readRDS("results/gaussian_type_two.rds")
temp %>% 
  arrange(test, effectSize) %>% 
  print(n=5)
```

Multiple experiments are aggregated to calculate type II error rates.

```{r topFiveTwo, echo=FALSE, message=FALSE}
temp %>% 
  group_by(test, effectSize) %>%
  summarise(Type_II_Error = round(mean(pvalue > .05), 2)) %>%
  print(n=5)
rm(list = ls())
```

Like type I calculations, each simulated experiment is based on a sample size of 500. Each combination of effect size and test are repeated 5,000 times. Where possible, exact tests are included for comparison.

# Overall Type II Error Rate
All tests achieve near 0% type II error for a large enough effect size.

```{r typeTwoSummary, echo=FALSE, message=FALSE}
gaussian <- bind_rows(
  readRDS("results/gaussian_type_two.rds"),
  readRDS("results/gaussian_type_two_exact.rds")
)

gamma <- bind_rows(
  readRDS("results/gamma_type_two_rate.rds"),
  readRDS("results/gamma_type_two_scale.rds"),
  readRDS("results/gamma_type_two_shape.rds")
)

poisson <- readRDS("results/poisson_type_two.rds")

beta <- readRDS("results/beta_type_two.rds")

neg_binom <- bind_rows(
  readRDS("results/negative_binomial_type_two.rds"),
  readRDS("results/negative_binomial_type_two_exact.rds") %>%
    mutate(test = "negative_binomial_exact")
)

expon <- readRDS("results/exponential_type_two.rds")

binom <- bind_rows(
  readRDS("results/binomail_type_two.rds"),
  readRDS("results/binomial_type_two_exact.rds") %>%
    mutate(test = "binomial_exact")
)

cauchy <- readRDS("results/cauchy_type_two.rds")

invGauus <- readRDS("results/inverse_gaussian_type_two.rds")

empLik <- readRDS("results/empirical_mu_type_two.rds")

typeII <- bind_rows(
  gaussian,
  gamma, 
  poisson, 
  beta,
  neg_binom,
  expon,
  binom,
  cauchy,
  invGauus,
  empLik
) %>%
  drop_na()

mark_exact_likelihood <- function(test) {
  type <- case_when(
    str_detect(test, "t.test") ~ "exact",
    str_detect(test, "exact") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "_one_sample") ~ "likelihood",
    TRUE ~ "ERROR")
  
  return(type)
}

typeII <- typeII %>%
  mutate(type = mark_exact_likelihood(test))
# typeII %>% distinct(type, test) %>% arrange(type, test) %>% print(N=Inf)

link_exact_to_likelihood <- function(test) {
  test2 <- case_when(
    str_detect(test, "t.test") ~ "gaussian_mu_one_sample",
    str_detect(test, "varTest") ~ "gaussian_variance_one_sample",
    str_detect(test, "geometric_exact") ~ "geometric_p_one_sample",
    str_detect(test, "negative_binomial_exact") ~ "negative_binomial_p_one_sample",
    str_detect(test, "binomial_exact") ~ "binomial_p_one_sample",
    str_detect(test, "_one_sample") ~ test,
    TRUE ~ "ERROR")
}

typeII <- typeII %>%
  mutate(test2 = link_exact_to_likelihood(test))
# typeII %>% distinct(type, test, test2) %>% arrange(type, test, test2) %>% print(N=Inf)

temp <- typeII %>%
  group_by(type, test2, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE), N = sum(!is.na(pvalue))) %>%
  arrange(desc(TypeII)) %>%
  ungroup() %>%
  group_by(type, test2) %>%
  summarise(TypeII = min(TypeII)) %>%
  ungroup()

ggplot(temp, aes(x = TypeII, y = test2, color = factor(type))) + 
  geom_point() +
  scale_x_continuous(breaks = seq(0, 1, .10), limits = c(0, 1)) + 
  labs(x = "Minimum Type II Error Rate", y = "Test", color = "Type")

rm(list = ls())


```

# Analysis Criteria
For a distribution, the likelihood ratio test works well if both of the following are true.

* Type II error rates are near zero for large effect sizes.
* When exact tests are implemented in R, type II error rates are similar to the exact test.

To check the above, one graph is shown per test. When the effect size is near 0, type II error rates are near  100%. As effect size grows, type II error rates decrease. All tests achieve near 0% type II for large enough effect sizes.

## Gaussian
```{r gaussainTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- bind_rows(
  readRDS("results/gaussian_type_two.rds"),
  readRDS("results/gaussian_type_two_exact.rds")
)

typeII <- typeII %>%
  mutate(test = factor(test, levels = c("gaussian_mu_one_sample", "t.test", "gaussian_variance_one_sample", "varTest")))

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  filter(test %in% c("gaussian_mu_one_sample", "t.test")) %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-.50, .50, .20)) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error", caption = "Null: mu = 0") + 
  facet_grid(rows = vars(alt), cols = vars(test))

temp %>%
  filter(test %in% c("gaussian_variance_one_sample", "varTest")) %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-5, 5, 2)) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error", caption = "Null: variance = 15") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())

```

## Gamma
```{r gammaTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- bind_rows(
  readRDS(file = "results/gamma_type_two_rate.rds"),
  readRDS(file = "results/gamma_type_two_scale.rds"),
  readRDS(file = "results/gamma_type_two_shape.rds")
)

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error") + 
  facet_grid(rows = vars(alt), cols = vars(test), scales = "free_x")

rm(list = ls())

```


## Poisson
```{r poissonTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- readRDS("results/poisson_type_two.rds")

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-.6, .6, .20), labels = comma) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error", caption = "Null: lambda = 5") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())

```

## Beta
```{r betaTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- readRDS("results/beta_type_two.rds")

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())

```

## Exponential
```{r exponentialTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- readRDS("results/exponential_type_two.rds")

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error", caption = "Null: rate = 5") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())

```

## Binomial
```{r binomTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- bind_rows(
  readRDS("results/binomail_type_two.rds"),
  readRDS("results/binomial_type_two_exact.rds")
)

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2),
         effectSize = round(effectSize, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-.16, .16, .04)) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error", caption = "Null: p = .50") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())

```

## Negative Binomial
```{r negativeBonimialTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- bind_rows(
  readRDS("results/negative_binomial_type_two.rds"),
  readRDS("results/negative_binomial_type_two_exact.rds")
)

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2),
         effectSize = round(effectSize, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-.45, .45, .10)) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error", caption = "Null: p = .50") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())
```

## Cauchy
```{r CauchyTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- readRDS("results/cauchy_type_two.rds")

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-4, 5, 1)) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())

```

## Inverse Gaussian
```{r InvGaussII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- readRDS("results/inverse_gaussian_type_two.rds")

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-10, 10, 2)) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error") + 
  facet_grid(rows = vars(alt), cols = vars(test), scales = "free_x")

rm(list = ls())

```

## Empirical Likelihood
```{r empTypeII, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
typeII <- readRDS("results/empirical_mu_type_two.rds")

temp <- typeII %>%
  group_by(test, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05, na.rm = TRUE)) %>%
  arrange(desc(TypeII)) %>%
  mutate(TypeII = round(TypeII, 2))

temp %>%
  ggplot(aes(x = effectSize, y = TypeII)) +
  geom_point() + 
  scale_x_continuous(breaks = seq(-.7, .7, .20), labels = comma) +
  scale_y_continuous(breaks = seq(0, 1, .20), limit = c(0, 1)) +
  labs(x = "Effect Size", y = "Type II Error", caption = "Null: mu = 3") + 
  facet_grid(rows = vars(alt), cols = vars(test))

rm(list = ls())

```
