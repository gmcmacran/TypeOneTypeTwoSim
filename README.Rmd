---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(tidyverse, warn.conflicts= FALSE)
options(dplyr.summarise.inform = FALSE)
```

# Repo Overview
This repo is a simulation study of statistical properties for hypothesis tests in LRTesteR. Each row is an experiment where data are generated from random number generators and hypothesis test are done. The first five rows look like

```{r topFiveOne, echo=FALSE, message=FALSE}
temp <- readRDS("results/gaussian_type_one.rds")
temp %>% 
  arrange(test, mu, variance) %>% 
  print(n=5)
```

For each simulated experiment, both the true hypothesis and the outcome of the test are known. Multiple experiments are aggregated to calculate type I error rates.

```{r topFiveTwo, echo=FALSE, message=FALSE}
temp %>% 
  group_by(test, mu, variance) %>%
  summarise(Type_I_Error = round(mean(pvalue <= .05), 2)) %>%
  print(n=5)
rm(list = ls())
```

Each simulated experiment is based on a sample size of 500. Each combination of true hypothesis, parameter value, and test are repeated 5,000 times.

Detailed statistical analysis can be found in the type I and type II folders. Code to run the simulation is in the R Code folder.

# One Sample Type I Error Rate
Most tests have a type I error rate of 5%. Likelihood ratio tests have similar error rates to exact tests.

```{r typeOneSummary, echo=FALSE, message=FALSE}
gaussian <- bind_rows(
  readRDS("results/gaussian_type_one.rds"),
  readRDS("results/gaussian_type_one_exact.rds")
)
gaussian <- gaussian %>% 
  filter(test %in% c("gaussian_mu_one_sample", "t.test")) %>%
  select(test, alt, param = mu, pvalue) %>%
  bind_rows(gaussian %>% 
              filter(test %in% c("gaussian_variance_one_sample", "varTest")) %>%
              select(test, alt, param = variance, pvalue))

gamma <- bind_rows(
  readRDS("results/gamma_type_one_rate.rds"),
  readRDS("results/gamma_type_one_scale.rds"),
  readRDS("results/gamma_type_one_shape.rds")
)
gamma <- gamma %>% 
  filter(test %in% c("gamma_rate_one_sample")) %>%
  select(test, alt, param = rate, pvalue) %>%
  bind_rows(gamma %>% 
              filter(test %in% c("gamma_scale_one_sample")) %>%
              select(test, alt, param = scale, pvalue),
            gamma %>% 
              filter(test %in% c("gamma_shape_one_sample")) %>%
              select(test, alt, param = shape, pvalue))

poisson <- readRDS("results/poisson_type_one.rds")
poisson <- poisson %>%
  select(test, alt, param = lambda, pvalue)


beta <- bind_rows(
  readRDS("results/beta_type_one_shape1.rds"),
  readRDS("results/beta_type_one_shape2.rds")
)
beta <- beta %>% 
  filter(test %in% c("beta_shape1_one_sample")) %>%
  select(test, alt, param = shape1, pvalue) %>%
  bind_rows(beta %>% 
              filter(test %in% c("beta_shape2_one_sample")) %>%
              select(test, alt, param = shape2, pvalue))

neg_binom <- bind_rows(
  readRDS("results/negative_binomial_type_one.rds"),
  readRDS("results/negative_binomial_type_one_exact.rds")  %>%
    mutate(test = "negative_binomial_exact")
)
neg_binom <- neg_binom %>% 
  select(test, alt, param = p, pvalue)

expon <- readRDS("results/exponential_type_one.rds")
expon <- expon %>% 
  select(test, alt, param = rate, pvalue)

binom <- bind_rows(
  readRDS("results/binomail_type_one.rds"),
  readRDS("results/binomial_type_one_exact.rds") %>%
    mutate(test = "binomial_exact")
)
binom <- binom %>% 
  select(test, alt, param = p, pvalue)

cauchy <- readRDS("results/cauchy_type_one.rds")
cauchy <- cauchy %>% 
  filter(test == "cauchy_location_one_sample") %>%
  select(test, alt, param = location, pvalue) %>%
  bind_rows(cauchy %>% 
              filter(test == "cauchy_scale_one_sample") %>%
              select(test, alt, param = scale, pvalue))

invGauus <- readRDS("results/inverse_gaussian_type_one.rds")
invGauus <- invGauus %>% 
  filter(test == "inverse_gaussian_mu_one_sample") %>%
  select(test, alt, param = mu, pvalue) %>%
  bind_rows(invGauus %>% 
              filter(test == "inverse_gaussian_shape_one_sample") %>%
              select(test, alt, param = shape, pvalue),
            invGauus %>% 
              filter(test == "inverse_gaussian_dispersion_one_sample") %>%
              select(test, alt, param = dispersion, pvalue))

empLik <- readRDS("results/empirical_type_one.rds")
empLik <- empLik %>% 
  filter(test %in% c("empirical_mu_one_sample")) %>%
  select(test, alt, param = mu, pvalue)


typeI <- bind_rows(
  gaussian,
  gamma, 
  poisson, 
  beta,
  neg_binom,
  expon,
  binom,
  cauchy,
  invGauus,
  empLik
)

mark_exact_likelihood <- function(test) {
  type <- case_when(
    str_detect(test, "t.test") ~ "exact",
    str_detect(test, "exact") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "_one_sample") ~ "likelihood",
    TRUE ~ "ERROR")
  
  return(type)
}

typeI <- typeI %>%
  mutate(type = mark_exact_likelihood(test))
# typeI %>% distinct(type, test) %>% arrange(type, test) %>% print(N=Inf)

link_exact_to_likelihood <- function(test) {
  test2 <- case_when(
    str_detect(test, "t.test") ~ "gaussian_mu_one_sample",
    str_detect(test, "varTest") ~ "gaussian_variance_one_sample",
    str_detect(test, "geometric_exact") ~ "geometric_p_one_sample",
    str_detect(test, "negative_binomial_exact") ~ "negative_binomial_p_one_sample",
    str_detect(test, "binomial_exact") ~ "binomial_p_one_sample",
    str_detect(test, "_one_sample") ~ test,
    TRUE ~ "ERROR")
}

typeI <- typeI %>%
  mutate(test2 = link_exact_to_likelihood(test))
# typeI %>% distinct(type, test, test2) %>% arrange(type, test, test2) %>% print(N=Inf)

temp <- typeI %>%
  group_by(type, test2) %>%
  summarise(TypeI = mean(pvalue <= .05), N = sum(!is.na(pvalue))) %>%
  arrange(desc(TypeI)) %>%
  ungroup()

ggplot(temp, aes(x = TypeI, y = test2, color = factor(type))) + 
  geom_point() +
  geom_vline(xintercept = .05) + 
  scale_x_continuous(breaks = seq(-.01, 1.01, .02), limits = c(0, .10)) + 
  labs(x = "Type I Error Rate", y = "Test", color = "Type")

rm(list = ls())
```

# One Way Type I Error Rate
Compared to the one sample tests, type I error rates are further from the .05 target. 

For the one sample tests, all 500 data points are associated with one group. The one parameter is estimated using all 500 data points. For the one way tests, there are two groups and therefore two parameters estimated. Each parameter is based on only 250 data points. The cost of less data per parameter is a type I error further from the target 5%. 

```{r typeOneSummary2, echo=FALSE, message=FALSE}
gaussian <- readRDS("results/gaussian_type_one_one_way.rds")
gaussian <- gaussian %>% 
  filter(test %in% c("gaussian_mu_one_way")) %>%
  select(test, alt, param = mu, pvalue) %>%
  bind_rows(gaussian %>% 
              filter(test %in% c("gaussian_variance_one_way")) %>%
              select(test, alt, param = variance, pvalue))

gamma <- bind_rows(
  readRDS("results/gamma_type_one_rate_one_way.rds"),
  readRDS("results/gamma_type_one_scale_one_way.rds"),
  readRDS("results/gamma_type_one_shape_one_way.rds")
)
gamma <- gamma %>% 
  filter(test %in% c("gamma_rate_one_way")) %>%
  select(test, alt, param = rate, pvalue) %>%
  bind_rows(gamma %>% 
              filter(test %in% c("gamma_scale_one_way")) %>%
              select(test, alt, param = scale, pvalue),
            gamma %>% 
              filter(test %in% c("gamma_shape_one_way")) %>%
              select(test, alt, param = shape, pvalue))

poisson <- readRDS("results/poisson_type_one_one_way.rds")
poisson <- poisson %>%
  select(test, alt, param = lambda, pvalue)


beta <- bind_rows(
  readRDS("results/beta_type_one_one_way_shape1.rds"),
  readRDS("results/beta_type_one_one_way_shape2.rds")
)
beta <- beta %>% 
  filter(test %in% c("beta_shape1_one_way")) %>%
  select(test, alt, param = shape1, pvalue) %>%
  bind_rows(beta %>% 
              filter(test %in% c("beta_shape2_one_way")) %>%
              select(test, alt, param = shape2, pvalue))

neg_binom <- readRDS("results/negative_binomial_type_one_one_way.rds")
neg_binom <- neg_binom %>% 
  select(test, alt, param = p, pvalue)

expon <- readRDS("results/exponential_type_one_one_way.rds")
expon <- expon %>% 
  select(test, alt, param = rate, pvalue)

binom <- readRDS("results/binomail_type_one_one_way.rds")
binom <- binom %>% 
  select(test, alt, param = p, pvalue)

cauchy <- readRDS("results/cauchy_type_one_one_way.rds")
cauchy <- cauchy %>% 
  filter(test == "cauchy_location_one_way") %>%
  select(test, alt, param = location, pvalue) %>%
  bind_rows(cauchy %>% 
              filter(test == "cauchy_scale_one_way") %>%
              select(test, alt, param = scale, pvalue))

invGauus <- readRDS("results/inverse_gaussian_type_one_one_way.rds")
invGauus <- invGauus %>% 
  filter(test == "inverse_gaussian_mu_one_way") %>%
  select(test, alt, param = mu, pvalue) %>%
  bind_rows(invGauus %>% 
              filter(test == "inverse_gaussian_shape_one_way") %>%
              select(test, alt, param = shape, pvalue),
            invGauus %>% 
              filter(test == "inverse_gaussian_dispersion_one_way") %>%
              select(test, alt, param = dispersion, pvalue))

empLike <- readRDS("results/empirical_type_one_one_way.rds")
empLike <- empLike %>% 
  filter(test %in% c("empirical_mu_one_way")) %>%
  select(test, alt, param = mu, pvalue)


typeI <- bind_rows(
  gaussian,
  gamma, 
  poisson, 
  beta,
  neg_binom,
  expon,
  binom,
  cauchy,
  invGauus,
  empLike
)

temp <- typeI %>%
  group_by(test) %>%
  summarise(TypeI = mean(pvalue <= .05), N = sum(!is.na(pvalue))) %>%
  arrange(desc(TypeI)) %>%
  ungroup()

ggplot(temp, aes(x = TypeI, y = test)) + 
  geom_point() +
  geom_vline(xintercept = .05) + 
  scale_x_continuous(breaks = seq(-.01, 1.01, .02), limits = c(0, .10)) + 
  labs(x = "Type I Error Rate", y = "Test", color = "Type")

rm(list = ls())
```

# One Sample Type II Error Rate
All tests achieve near 0% type II error for a large enough effect size.

```{r typeTwoSummary, echo=FALSE, message=FALSE}
gaussian <- bind_rows(
  readRDS("results/gaussian_type_two.rds"),
  readRDS("results/gaussian_type_two_exact.rds")
)

gamma <- bind_rows(
  readRDS("results/gamma_type_two_rate.rds"),
  readRDS("results/gamma_type_two_scale.rds"),
  readRDS("results/gamma_type_two_shape.rds")
)

poisson <- readRDS("results/poisson_type_two.rds")

beta <- readRDS("results/beta_type_two.rds")

neg_binom <- bind_rows(
  readRDS("results/negative_binomial_type_two.rds"),
  readRDS("results/negative_binomial_type_two_exact.rds") %>%
    mutate(test = "negative_binomial_exact")
)

expon <- readRDS("results/exponential_type_two.rds")

binom <- bind_rows(
  readRDS("results/binomail_type_two.rds"),
  readRDS("results/binomial_type_two_exact.rds") %>%
    mutate(test = "binomial_exact")
)

cauchy <- readRDS("results/cauchy_type_two.rds")

invGauus <- readRDS("results/inverse_gaussian_type_two.rds")

empLik <- readRDS("results/empirical_type_two.rds")

typeII <- bind_rows(
  gaussian,
  gamma, 
  poisson, 
  beta,
  neg_binom,
  expon,
  binom,
  cauchy,
  invGauus,
  empLik
)

mark_exact_likelihood <- function(test) {
  type <- case_when(
    str_detect(test, "t.test") ~ "exact",
    str_detect(test, "exact") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "_one_sample") ~ "likelihood",
    TRUE ~ "ERROR")
  
  return(type)
}

typeII <- typeII %>%
  mutate(type = mark_exact_likelihood(test))
# typeII %>% distinct(type, test) %>% arrange(type, test) %>% print(N=Inf)

link_exact_to_likelihood <- function(test) {
  test2 <- case_when(
    str_detect(test, "t.test") ~ "gaussian_mu_one_sample",
    str_detect(test, "varTest") ~ "gaussian_variance_one_sample",
    str_detect(test, "geometric_exact") ~ "geometric_p_one_sample",
    str_detect(test, "negative_binomial_exact") ~ "negative_binomial_p_one_sample",
    str_detect(test, "binomial_exact") ~ "binomial_p_one_sample",
    str_detect(test, "_one_sample") ~ test,
    TRUE ~ "ERROR")
}

typeII <- typeII %>%
  mutate(test2 = link_exact_to_likelihood(test))
# typeII %>% distinct(type, test, test2) %>% arrange(type, test, test2) %>% print(N=Inf)

temp <- typeII %>%
  group_by(type, test2, alt, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05), N = sum(!is.na(pvalue))) %>%
  arrange(desc(TypeII)) %>%
  ungroup() %>%
  group_by(type, test2) %>%
  summarise(TypeII = min(TypeII)) %>%
  ungroup()

ggplot(temp, aes(x = TypeII, y = test2, color = factor(type))) + 
  geom_point() +
  scale_x_continuous(breaks = seq(0, 1, .10), limits = c(0, 1)) + 
  labs(x = "Minimum Type II Error Rate", y = "Test", color = "Type")

rm(list = ls())
```

# One Way Type II Error Rate
Similar to above, all one way tests have near 0% type II error rate for large effect sizes.

```{r typeTwoSummary2, echo=FALSE, message=FALSE}
gaussian <- readRDS("results/gaussian_type_two_one_way.rds")

gamma <- bind_rows(
  readRDS(file = "results/gamma_type_two_rate_one_way.rds"),
  readRDS(file = "results/gamma_type_two_scale_one_way.rds"),
  readRDS(file = "results/gamma_type_two_shape_one_way.rds")
)

poisson <- readRDS("results/poisson_type_two_one_way.rds")

beta <- readRDS("results/beta_type_two_one_way.rds")

neg_binom <- readRDS("results/negative_binomial_type_two_one_way.rds")

expon <- readRDS("results/exponential_type_two_one_way.rds")

binom <- readRDS("results/binomail_type_two_one_way.rds")

cauchy <- readRDS("results/cauchy_type_two_one_way.rds")

invGauus <- readRDS("results/inverse_gaussian_type_two_one_way.rds")

empLik <- readRDS("results/empirical_type_two_one_way.rds")

typeII <- bind_rows(
  gaussian,
  gamma, 
  poisson, 
  beta,
  neg_binom,
  expon,
  binom,
  cauchy,
  invGauus,
  empLik
)
temp <- typeII %>%
  group_by(test, effectSize) %>%
  summarise(TypeII = mean(pvalue > .05), N = sum(!is.na(pvalue))) %>%
  arrange(desc(TypeII)) %>%
  ungroup() %>%
  group_by(test) %>%
  summarise(TypeII = min(TypeII)) %>%
  ungroup()

ggplot(temp, aes(x = TypeII, y = test)) + 
  geom_point() +
  scale_x_continuous(breaks = seq(0, 1, .10), limits = c(0, 1)) + 
  labs(x = "Minimum Type II Error Rate", y = "Test", color = "Type")

rm(list = ls())
```

# Confidence Interval Coverage
In addition to error rates, confidence interval coverage rates are estimated. Most functions have a coverage rate of 95%. The worst performing confidence intervals are within one percentage point.

```{r CISummary, echo=FALSE, message=FALSE}
library(tidyverse, warn.conflicts= FALSE)
options(dplyr.summarise.inform = FALSE)

gaussian <- bind_rows(
  readRDS("results/gaussian_type_one.rds"),
  readRDS("results/gaussian_type_one_exact.rds")
)
gaussian <- gaussian %>% 
  filter(test %in% c("gaussian_mu_one_sample", "t.test")) %>%
  select(test, alt, param = mu, CI_LB, CI_UB) %>%
  bind_rows(gaussian %>% 
              filter(test %in% c("gaussian_variance_one_sample", "varTest")) %>%
              select(test, alt, param = variance, CI_LB, CI_UB))

gamma <- bind_rows(
  readRDS("results/gamma_type_one_rate.rds"),
  readRDS("results/gamma_type_one_scale.rds"),
  readRDS("results/gamma_type_one_shape.rds")
)
gamma <- gamma %>% 
  filter(test %in% c("gamma_rate_one_sample")) %>%
  select(test, alt, param = rate, CI_LB, CI_UB) %>%
  bind_rows(gamma %>% 
              filter(test %in% c("gamma_scale_one_sample")) %>%
              select(test, alt, param = scale, CI_LB, CI_UB),
            gamma %>% 
              filter(test %in% c("gamma_shape_one_sample")) %>%
              select(test, alt, param = shape, CI_LB, CI_UB))

poisson <- readRDS("results/poisson_type_one.rds")
poisson <- poisson %>%
  select(test, alt, param = lambda, CI_LB, CI_UB)


beta <- bind_rows(
  readRDS("results/beta_type_one_shape1.rds"),
  readRDS("results/beta_type_one_shape2.rds")
)
beta <- beta %>% 
  filter(test %in% c("beta_shape1_one_sample")) %>%
  select(test, alt, param = shape1, CI_LB, CI_UB) %>%
  bind_rows(beta %>% 
              filter(test %in% c("beta_shape2_one_sample")) %>%
              select(test, alt, param = shape2, CI_LB, CI_UB))

neg_binom <- readRDS("results/negative_binomial_type_one.rds")
neg_binom <- neg_binom %>% 
  select(test, alt, param = p, CI_LB, CI_UB)

expon <- readRDS("results/exponential_type_one.rds")
expon <- expon %>% 
  select(test, alt, param = rate, CI_LB, CI_UB)

binom <- bind_rows(
  readRDS("results/binomail_type_one.rds"),
  readRDS("results/binomial_type_one_exact.rds") %>%
    mutate(test = "binomial_exact")
)
binom <- binom %>% 
  select(test, alt, param = p, CI_LB, CI_UB)

cauchy <- readRDS("results/cauchy_type_one.rds")
cauchy <- cauchy %>% 
  filter(test == "cauchy_location_one_sample") %>%
  select(test, alt, param = location, CI_LB, CI_UB) %>%
  bind_rows(cauchy %>% 
              filter(test == "cauchy_scale_one_sample") %>%
              select(test, alt, param = scale, CI_LB, CI_UB))

invGauus <- readRDS("results/inverse_gaussian_type_one.rds")
invGauus <- invGauus %>% 
  filter(test == "inverse_gaussian_mu_one_sample") %>%
  select(test, alt, param = mu, CI_LB, CI_UB) %>%
  bind_rows(invGauus %>% 
              filter(test == "inverse_gaussian_shape_one_sample") %>%
              select(test, alt, param = shape, CI_LB, CI_UB),
            invGauus %>% 
              filter(test == "inverse_gaussian_dispersion_one_sample") %>%
              select(test, alt, param = dispersion, CI_LB, CI_UB))

empLik <- readRDS("results/empirical_type_one.rds")
empLik <- empLik %>% 
  filter(test %in% c("empirical_mu_one_sample")) %>%
  mutate(CI_LB = if_else(is.na(CI_LB), -Inf, CI_LB),
         CI_UB = if_else(is.na(CI_UB), Inf, CI_UB)) %>%
  select(test, alt, param = mu, CI_LB, CI_UB)


coverage <- bind_rows(
  gaussian,
  gamma, 
  poisson, 
  beta,
  neg_binom,
  expon,
  binom,
  cauchy,
  invGauus,
  empLik
)

mark_exact_likelihood <- function(test) {
  type <- case_when(
    str_detect(test, "t.test") ~ "exact",
    str_detect(test, "exact") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "varTest") ~ "exact",
    str_detect(test, "_one_sample") ~ "likelihood",
    TRUE ~ "ERROR")
  
  return(type)
}

coverage <- coverage %>%
  mutate(type = mark_exact_likelihood(test))
# coverage %>% distinct(type, test) %>% arrange(type, test) %>% print(N=Inf)

link_exact_to_likelihood <- function(test) {
  test2 <- case_when(
    str_detect(test, "t.test") ~ "gaussian_mu_one_sample",
    str_detect(test, "varTest") ~ "gaussian_variance_one_sample",
    str_detect(test, "geometric_exact") ~ "geometric_p_one_sample",
    str_detect(test, "negative_binomial_exact") ~ "negative_binomial_p_one_sample",
    str_detect(test, "binomial_exact") ~ "binomial_p_one_sample",
    str_detect(test, "_one_sample") ~ test,
    TRUE ~ "ERROR")
}

coverage <- coverage %>%
  mutate(test2 = link_exact_to_likelihood(test))
# coverage %>% distinct(type, test, test2) %>% arrange(type, test, test2) %>% print(N=Inf)

temp <- coverage %>%
  group_by(type, test2) %>%
  summarise(covRate = mean(CI_LB <= param & param <= CI_UB), N = n()) %>%
  arrange(desc(covRate)) %>%
  ungroup()

ggplot(temp, aes(x = covRate, y = test2, color = factor(type))) + 
  geom_point() +
  geom_vline(xintercept = .95) + 
  scale_x_continuous(breaks = seq(0, 1, .02), limits = c(.90, 1)) + 
  labs(x = "Coverage Rate", y = "Confidence Interval", color = "Type")

rm(list = ls())
```
